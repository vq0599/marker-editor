

const fs = require('fs')
const cheerio = require('cheerio');

const dir = './src/assets/svg'
const output = './src/utils'
const filename = 'icon-inner.js'

const readSvg = (file) => {
  return new Promise((resolve, reject) => {
    fs.readFile(`${dir}/${file}`, 'utf8', (err, xml) => {
      if (err) reject(err)
      resolve(xml)
    });
  })
}

fs.readdir(dir, (_, files) => {
  const pms = []
  files.filter(file => /.svg$/.test(file)).forEach(file => {
    const key = file.slice(0, file.length - 4)
    pms.push(readSvg(file).then(value => ({ key, value, })))

  })

  Promise.all(pms).then(tokens => {
    const svgMap = {}
    tokens.forEach(({ key, value },) => {
      const $ = cheerio.load(value);
      svgMap[key] = $('svg').html()
    })

    const content = `/* eslint-disable */\nexport default ${JSON.stringify(svgMap, null, 2)}\n/**\n * generated by icon-generate.js\n */`

    fs.writeFile(`${output}/${filename}`, content, (err) => {
      if (err) throw err;
      console.log(`The file "${filename}" has been created!`);
    })
  })
})

